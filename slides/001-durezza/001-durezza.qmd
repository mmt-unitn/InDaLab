---
title: "Misure di durezza"
author: "Tommaso Stefani"
date: today
draft: false
categories: 
  - tesi
abstract: >
  In questa attivtà si conducono prove di durezza su materiali metallici per valutare statisticamente l'impatto sulla misura causato dall'uso di un'indentatore danneggiato.
format: revealjs
---
```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(
  fig.align = "center",
  # This for default device
  out.width = "16cm",
  # This two for high quality charts:
  fig.dim = c(16, 9)*0.4
)
library(tidyverse)
library(stringr)
library(modelr)
library(broom)
library(knitr)
library(patchwork)
```

# Descrizione dell'esperienza {.centered-slide}

## Descrizione dell'esperienza

L’attività si concentra sulla **misurazione della durezza Vickers** di materiali metallici utilizzando un durometro da laboratorio.

I dati raccolti saranno utilizzati per due tipi di analisi statistiche:

- **Test di Student accoppiato**: per verificare l’impatto effettivo di un indentatore danneggiato su eventuali anomalie nelle misure.  
- **Taratura degli strumenti di misura**: sviluppo del modello analitico che lega il valore di stima fornito dal durometro sulla base della sola profondità dell'impronta con la misura reale e relativa regressione.

Il percorso prevede quindi la pianificazione delle misure, l’esecuzione in laboratorio e l’analisi statistica dei dati ottenuti.


## Descrizione dell'esperienza

Gli **obiettivi** si possono riassumere quindi nei seguenti:

* Acquisire competenze nella **misura della durezza dei materiali**.

* **Valutare la significatività statistica** dell’impatto di un indentatore danneggiato sulle misure. 

* **Regredire una caratteristica di taratura** che correli la stima fornita dal durometro sulla base della sola profondità di impronta con il valore reale di durezza.


# Richiami teorici

## Durezza dei materiali

::: {.callout-note title="Definizione – Durezza"}

La **durezza** è la proprietà meccanica dei materiali che esprime la loro resistenza alla deformazione plastica locale, determinata mediante prove di penetrazione, graffiatura o abrasione.  
Essa rappresenta la capacità di un materiale ad opporsi alla formazione di impronte permanenti sotto l'azione di un corpo più duro.

:::

* La durezza si valuta a partire dalla misura dell’impronta lasciata da un penetratore sul materiale, con metodi diversi a seconda del tipo di prova adottata.

* Le misure di durezza sono relative e dipendono dal metodo e dalle condizioni di prova, perciò è essenziale indicare sempre la sigla della scala utilizzata (es. HV30).

* La durezza è una grandezza empirica che dipende da molteplici fattori materiali e di prova, senza una propria unità di misura.

## Durezza dei materiali

Alla luce di quanto detto è evidente come non esista un metodo generale di conversione tra le diverse scale di misura della durezza (corrispondenti ai diversi metodi di prova utilizzati) ma solo tentativi di raffronto sperimentali.

<div style="text-align:center">
![Confronto tra scale di durezza diverse, Scienza ed ingegneria dei materiali, Callister & Rethwisch, *IV edizione*, p. 169](images/confronto_scale.jpg){width=22% fig-align="center"}
</div>

## Durezza dei materiali

Le **prove di durezza** sono molto utilizzate perché:

1. Sono **semplici e poco costose**: richiedono minima preparazione del campione e strumenti economici.
2. Sono quasi **non distruttive**: l’unico effetto sul campione è una piccola impronta.
3. Permettono di **stimare altre proprietà meccaniche**, come la resistenza a rottura (approssimativamente).

Tra le scale di durezza più comuni vi sono: Mohs,Brinell, Rockwell e Vickers. In particolare, la scala Vickers è adottata nelle misure del presente esperimento. 


## Scala Mohs

::: {.callout-note title="Scala Mohs"}

La **scala Mohs** è un sistema ideato nel 1812 dal mineralogista tedesco *Friedrich Mohs* per classificare i materiali in base alla loro durezza, intesa come resistenza alla graffiatura. 
Si tratta di un metodo empirico e comparativo, che non fornisce un valore numerico assoluto, ma piuttosto consente di stabilire se un materiale è più o meno duro rispetto a un altro.
:::

* La scala Mohs classifica la durezza su 10 livelli, da 1 (talco, il più tenero) a 10 (diamante, il più duro); ogni minerale può graffiare solo quelli con durezza inferiore al proprio livello.

* La scala Mohs è ancora usata in geologia e mineralogia per identificazioni rapide, ma **non è adatta per applicazioni tecniche o industriali**, dove sono preferiti metodi che danno risultati quantitativi e ripetibili.


## Scala Rockwell

::: {.callout-note title="Scala Rockwell"}

La **prova Rockwell** è un metodo per misurare la durezza dei materiali basato sulla misura della profondità residua di penetrazione di un penetratore standardizzato, dopo l’applicazione sequenziale di un carico preliminare e uno principale, secondo procedure normalizzate.
:::

La procedura prevede 3 fasi:

-   preparazione dei campioni
-   Applicazione di un **precarico** per stabilizzare il contatto;
-   Applicazione e successiva rimozione del **carico principale**, dopo cui si misura la profondità $h$ dell’impronta residua.


## Scala Rockwell

Il valore di durezza Rockwell si calcola mediante la formula:

$$
HR = N - \frac{h}{s}
$$

dove:

- $HR$ è il valore di durezza, 
- $h$ è la profondità residua dell’impronta (mm),
- $s = 0.002 \, \text{mm}$ è il coefficiente di scala, 
- $N$ è una costante che dipende dalla scala (es. $N = 100$ per la scala HRC).


## Scala Rockwell

Le diverse scale Rockwell si distinguono per: 

- tipo di **penetratore** (cono in diamante o sfera di diverse dimensioni), 
- **carico appplicato** 

Per riportare il valore di durezza di un materiale si usa la seguente sigla:
$$
HRxx\ yy
$$

- $HR$: prova Rockwell  
- $xx$: scala utilizzata (per es.  C)  
- $yy$: valore di durezza rilevato sulla scala C


## Scala Rockwell

* La prova Rockwell rappresenta un metodo molto semplice e molto utilizzato in quanto non richiede particolari conoscenze da parte dell'operatore. Questo perchè si basa su una misura determinata automaticamente dalla macchina (la profondità dell'impronta). 

* riferimento normativo: **UNI EN ISO 6508-1:2016**

## Scala Brinel

::: {.callout-note title="Scala Brinell"}

La **prova Brinell**  è un metodo che si basa sulla misura del diametro dell'impronta di penetrazione provocata da una **sfera in acciaio o carburo di tungsteno** sottoposta a un carico statico. 
E' una prova robusta che può essere applicata ad un ampio intervallo di durezze.
:::

Dopo l’applicazione del carico, si misura il **diametro dell’impronta** residua. La durezza Brinell si calcola mediante la formula:

$$
HBW = \frac{2P}{\pi D \left( D - \sqrt{D^2 - d^2} \right)}
$$

dove: 

- $P$: carico applicato (kgf)
- $D$: diametro della sfera (mm)
- $d$: diametro medio dell’impronta (mm)

## Scala Brinell

Per riportare il valore di durezza di un materiale si usa la seguente sigla:

$$
HBW\ xx/yy/zz
$$
dove:

- $HBW$: prova Brinell con sfera in carburo di tungsteno (HB se in acciaio) 
- $xx$: diametro della sfera (mm)  
- $yy$: carico applicato (kgf) 
- $zz$: tempo di applicazione del carico (s)

* La prova Brinell si caratterizza per essere una prova robusta che può essere applicata ad un ampio intervallo di durezze.
* riferimento normativo: **UNI EN ISO 6506-1**

## Scala Vickers

::: {.callout-note title="Scala Vickers"}

La **prova Vickers** è un metodo di prova basato sulla misurazione delle dimensioni di un’impronta ottenuta tramite un penetratore piramidale in diamante.
Durante la prova, si applica un carico statico definito, mantenuto per un determinato intervallo di tempo. Una volta rimosso il carico, si osserva l’impronta lasciata sulla superficie del campione.
:::

La durezza Vickers si determina misurando le diagonali dell’impronta con un microscopio e calcolando il rapporto tra carico applicato e area dell’impronta secondo la seguente formula:

$$
HV = \frac{1.854 \cdot P}{d^2}
$$

dove:

- $P$ è il carico applicato in kgf 
- $d$ è la lunghezza media delle due diagonali dell’impronta, espressa in millimetri.

## Scala Vickers

* Essendo una misura ottica, la prova Vickers richiede una preparazione accurata del campione con levigatura e lucidatura per garantire letture precise, ed è ideale per materiali metallici omogenei e microstrutture.

* La scala Vickers utilizza un penetratore con geometria fissa, ma il valore HV dipende dal carico applicato; poiché impronta e risposta del materiale variano con la forza, i risultati con carichi diversi non sono sempre confrontabili, soprattutto su materiali eterogenei o trattati superficialmente.

## Scala Vickers

Per riportare il valore di durezza di un materiale si usa la seguente sigla:

$$
HV xx/yy
$$

dove:

- $HV$: prova Vickers con penetratore a punta di diamante piramidale  
- $xx$: carico applicato in kgf  
- $yy$: tempo di applicazione del carico in secondi (opzionale, spesso non indicato)


Tutti i dettagli tecnici, i criteri di esecuzione e le tolleranze della prova sono regolati dalla norma **UNI EN ISO 6507-1**, che rappresenta il riferimento principale per l’applicazione corretta del metodo Vickers.

## Scala Vickers

In figura le caratteristiche principali che caratterizzano le prove Brinell e Vickers.


<div style="text-align:center">

![Sistemi di prova per la durezza, Scienza ed ingegneria dei materiali, Callister & Rethwisch, <i>IV edizione</i>, p. 167](images/brinell_vickers.jpg){width=110%}
</div>


## t_test

* Il t-test di Student è un test statistico che serve a confrontare le medie di due gruppi per capire se la differenza osservata sia dovuta al caso o a un effetto reale.

Esistono diverse varianti del t-test:

* ad uno due lati
* ad uno o due campioni
* t test accoppiato


In questa attività si utilizza il **test accoppiato**.

## t_test

Nel caso di test di Student a due campioni, quando essi **hanno la stessa dimensione e sono raccolti due a due in condizioni molto simili**, è opportuno accoppiarli e effettuare il **test di Student accoppiato**.

Ogni misura è esprimibile come:
$$
y_{ij}=\mu_i+\beta_j+\varepsilon_{ij};\hspace{9pt} \left\{ \begin{array}{l}i=1,2\\j=1,2,\dots ,n\end{array} \right.
$$
dove:

- $i$ identifica il campione
- $j$ identifica la singola misura di un campione

## t_test

Se si definisce $d_j=y_{1j} - y_{2j}$, ricordando le proprietà dell'operatore $E(\cdot)$, risulta $\mu_d = \mu_1 - \mu_2$. Quindi si può formulare la seguente coppia di ipotesi:
$$
\begin{eqnarray}
H_0 :~& \mu_d = 0 \\
H_1 :~& \mu_d \neq 0
\end{eqnarray}
$$
Il test accoppiato è quindi evidentemente un test a un campione, con il vantaggio che **gli effetti casuali tra coppie di osservazioni non influiscono sul risultato del test**


## Taratura

* Una misura è il risultato di una misurazione che descrive un parametro di un sistema in un certo stato.

* Le misurazioni possono essere:

  * dirette, se ottenute per confronto con un campione noto
  * indirette, se ricavate da grandezze correlate tramite un modello.

* Il modello è un insieme di relazioni tra parametri che descrive le interazioni nel sistema e rappresenta lo strumento di misura. Può essere analitico, numerico o empirico, e non richiede una comprensione fisica completa del sistema.

* Nel caso di misurazioni indirette, lo strumento si basa su un trasduttore e richiede un modello che ne descriva il comportamento. Se il modello è statico, non considera il tempo; se dinamico, sì. La taratura è il processo di identificazione dei parametri del modello.

## Taratura

::: {.callout-note title="Taratura"}
La **taratura** punta a definire la correlazione $y=f(m)$ tra l’ingresso misurando $m$ e l’uscita del trasduttore $y$, e la relativa incertezza. La $f(\cdot)$ è detta caratteristica statica dello strumento.
:::

* Uno strumento fornisce la misura mediante inversione della caratteristica statica: $m=f^{-1}(y)$

* Perché la $f(\cdot)$ sia nota è necessario identificarne i parametri mediante **regressione** che viene effettuata a partire da una serie di coppie $(m_i,y_i)$ ottenute:

  * da una serie di misurandi noti 
  * da una serie di misurazioni ottenute con uno strumento di qualità migliore di quello in taratura (questo perchè l'incertezza sui parametri della regressione non dipende dall'incertezza su queste misurazioni ma sulla variabilità dei dati raccolti)

## Taratura

La taratura statica si sviluppa quindi su quattro passaggi:

1. Sviluppo del modello dello strumento: analisi dei principi fisici per definire la caratteristica statica
2. Raccolta dei dati di taratura: campagna sperimentale per coppie $(m_i, y_i)$ in ordine casuale
3. Regressione: identificazione dei parametri del modello
4. Validazione del modello: verifica adeguatezza mediante analisi dei residui

La taratura deve anche definire l’incertezza dello strumento, dovuta al modello (la forma della caratteristica statica), ai parametri del modello e alla stima del misurando (dovuta a ingressi di disturbo).



# Parte sperimentale
## Attrezzatura necessaria

* 10 campioni di acciai ignoti (composizione non nota, trattamenti subiti non noti, ecc.)
* Carte abrasive: Non sono prescritte grane specifiche nelle normative, ma si consiglia di utilizzare una sequenza di abrasivi da grana 120 a 1200 per garantire una superficie liscia e priva di difetti
* detergente per superfici metalliche
* panno in microfibra o tessuto morbido che non rilasci fibre
* durometro per misurazione durezza VIckers
* penetatore Vickers danneggiato
* penetratore Vickers integro

## Fasi da seguire in laboratorio


* Scelta di 10 campioni di acciai ignoti
* Preparazione dei campioni:
    * I campioni devono essere accuratamente lucidati per ottenere una superficie liscia e priva di ossidazioni o impurità. Non sono prescritte grane specifiche nelle normative, ma si consiglia di utilizzare una sequenza di abrasivi da grana 120 a 1200. Se possibile lucidare a specchio.
    * Pulizia con panno morbido e detergente per metallo per rimuovere polveri o residui.


<div style="text-align:center">
![Campione prima e dopo preparazione superficiale](images/preparazione_campioni.jpg){#Preparazione_campioni width=15% .un}
</div>

## Fasi da seguire in laboratorio

*  Numerazione dei campioni: Indentificare i campioni numerandoli da 1 a 10 

<div style="text-align:center">
![Campioni numerati](images/campioni.jpg){width=15% #Campioni}
</div>

*  Montaggio indentatore Vickers danneggiato sulla macchina
*  Esecuzione delle prove previste dalla campagna di misure per l'indentatore danneggiato
*  Montaggio indentatore Vickers integro sulla macchina
*  Esecuzione delle prove previste dalla campagna di misure per l'indentatore integro

## Misurazione 

Per eseguire una misura di durezza:

* Poggiare il provino sul piano di supporto della macchina
* Ruotare il volantino portando in adesione il provino con l'elemento di contatto del durometro

<div style="text-align:center">
![Provino a contatto](images/contatto.jpg){width=20% #provino}
</div>

## Misurazione 

* Premere il tasto <span style="font-size:40%">$\begin{array}{c}\downarrow \\ - \\ \uparrow\end{array}$</span> che avvia il ciclo di misura
* Attendere la fine della prova, quindi che compaia l'immagine dell imnpronta sullo schermo, annotare la stima fornita dalla macchina.
* Azzerare la posizione del regolo portando a contatto i due corsoi del calibro, premere il tasto <span style="color:red;">f</span> (solo per prima misura dopo accensione)

<div style="text-align:center">
![Azzeramento del regolo](images/zeroregolo.jpg){width=15% #zeroregolo}
</div>

## Misurazione 

* Allineare la linea presente su uno dei due corsoi con una delle diagonali dell'impronta, in modo da fissare l'orientamento corretto per la misurazione 

<div style="text-align:center">
![Orientamento regolo](images/orientamento.jpg){width=22% #orientamento}
</div>


## Misurazione 

* Mantendendo l'orientamento ottenuto al punto precedente regolare attraverso i due pomelli presenti sul calibro la posizione dei due corsoi, in modo che le linee presenti sugli stessi combacino con i vertici della diagonale opposta a quella usata da riferimento al punto precedente


* Confermare con il tasto <span style="color:red;">f</span>.

<div style="text-align:center">
![Misura della diagonale](images/misura.jpg){width=18% #misura}
</div>

## Misurazione 

* Ripetere i precedenti punti  per l'altra diagonale
* Annotare la misura che compare a display
* Premere il tasto <span style="color:red;">f</span>

Per le misure che prevedono di usare due volte la stessa diagonale (quella chiaramente visibile dell'indentatore rotto) rilevare due volte la stessa diagonale.

<div style="text-align:center">
![Durometro EMCO TEST M4U 02](images/durometro.jpg){width=12% #Durometro}
</div>


# Elaborazione dei dati
## Confronto tra intentatore integro e danneggiato

E' necessario creare una tabella di raccolta dati, in colonna i valori delle misure e delle stime fornite dalla macchina per tutti i 10 provini usando

* indentatore integro (``HV30_OK` e `stima_OK`), 
* indentatore danneggiato (`HV30_NOK` e `stima_NOK`) 
* due volte la diagonale visibile dell'indentatore danneggiato (`HV30_dd` e ` stima_dd`). 

Si utilizza sempre la scala HV30.

## Confronto tra intentatore integro e danneggiato

```{r}
#| include: false
df_a<-tibble(
  material=1:10, #materiale
  HV30_OK=NA,    #misura effettiva, indentatore integro   
  HV30_NOK=NA,   #misura effettiva, indentatore danneggiato        
  stima_OK=NA,   #stima della macchina, indentatore integro
  stima_NOK=NA,  #stima della macchina, indentaore danneggiato
  HV30_dd=NA,    #misura effettiva usando due volte la diagonale visibile, indentatore danneggiato
  stima_dd=NA,   #stima della macchina, indentatore danneggiato per misura con doppia diagonale
)               

write.csv(df_a,"misure_HV_30.csv") #per avere la tabella in formato .csv così da poter essere riempita dallo sperimentatore

kable(head(df_a,8), caption = "Tabella di raccolta dati per T-test")
```


```{r}
df_a$stima_OK=c(591,205,209,262,318,578,206,156,624,581)
df_a$HV30_NOK = c(676,259,259,306,352,660,244,164,659,625)
df_a$HV30_OK=c(662,242,262,302,330,641,244,165,668,651)
df_a$stima_NOK = c(620,212,217,307,339,629,216,157,622,596)
df_a$HV30_dd=c(648,256,253,297,351,652,247,166,659,635)      
df_a$stima_dd=c(612,219,218,297,337,621,218,157,618,596)

kable(head(df_a,8),caption = "Tabella di raccolta dati per T-test")
```
## Confronto tra intentatore integro e danneggiato

Si considerano dapprima i dati relativi alle misure raccolte utilizzando diagonali diverse (le prime 4 colonne della tabella).


```{r}
#| include: false
dfv <- df_a %>%
  select(material:stima_NOK)%>%
  pivot_longer(-material, 
               names_sep="_", 
               names_to = c("misura","ok"), 
               values_to="durezza") %>% 
  mutate(ok=ifelse(ok=="OK","integro","rotto"))
dfv %>% head() %>% kable()
```
::: columns

::: {.column width="50%"}

```{r}
dfv %>% 
  ggplot(aes(x=misura, y=durezza, color=ok)) +
  geom_boxplot() +
  labs(x="Misura", y="Durezza", color="Penetratore")
```
:::

::: {.column width="50%"}

Una volta importati i dati si possono confrontare tutti i dati: 

* non si evidenzia alcuna differenza significativa in quanto la variabilità del materiale **maschera** le differenze tra i penetratori.
:::

:::
## Confronto tra intentatore integro e danneggiato
::: columns

::: {.column width="50%"}
```{r}
dfv %>%
  pivot_wider(names_from = misura, values_from = durezza) %>% 
  ggplot(aes(x=HV30, y=stima, color=ok)) + 
  geom_point() + 
  geom_smooth(method="lm", formula=y~x) +
  labs(color="penetratore") 
```
:::

::: {.column width="50%"}
Si osserva la relazione tra stima e durezza, separatamente per penetratore: 

* sembrano essere differenti sia l'intercetta che la pendenza.
:::

:::

## Confronto tra intentatore integro e danneggiato

::: columns

::: {.column width="50%"}
```{r}
dfv %>%
  pivot_wider(names_from = ok, values_from = durezza) %>% 
  ggplot(aes(x=integro, y=rotto, color=misura)) + 
  geom_abline(slope=1, intercept=0, color="red", lty=2) +
  geom_point() + 
  geom_smooth(method="lm", formula=y~x)
```
:::

::: {.column width="50%"}
Si osserva la relazione tra le misure fatte con indentatore rotto e indentatore integro:

* se non ci fosse differenza sarebbero allineate sulla retta diagonale con equazione $y=x$:
* i punti corrispondenti alla misura effettiva HV30  hanno una regressione che corrisponde alla diagonale
* i punti corrispondenti alla stima fornita dalla macchina hanno una regressione che è al di sopra della diagonale e i punti sono consistentemente al di sopra di essa,

:::

:::

Quanto osservato sta a significare che la stima fornisce una durezza maggiore per l'indentatore rotto che per quello integro.


## Confronto tra intentatore integro e danneggiato

Si effettuano i T-test per HV30 e per stima, si ottiene:

```{r}
dfv %>% pivot_wider(names_from = ok, values_from = durezza) %>% 
  split(~misura) %>% {
    reduce2(., names(.), \(acc, d, n) {
      t <- t.test(d$integro, d$rotto, paired = T)
      bind_rows(acc, tidy(t) %>% mutate(group=n, .before=1))
    }, .init=tibble())
  } %>% 
  relocate(p.value, .after=-1) %>% 
  mutate(
    significant = p.value < 0.05, 
    across(c(statistic, conf.low, conf.high, p.value), ~round(., 3))) %>%
  select(-method, -alternative) %>%
  kable()
```


## Confronto tra intentatore integro e danneggiato

Ciò che si evince è:


* Il danno al penetratore viene compensato dalla capacità dell’operatore di estrapolare dal contesto la posizione del vertice mancante nell’impronta. Questa compensazione è però soggettiva e dipende dall’esperienza e capacità dell’operatore.

* Viceversa, la misura basata sulla penetrazione è completamente oggettiva e risente quindi della integrità del penetratore: tanto più la geometria reale si discosta dalla geometria nominale per la quale è nota la relazione tra altezza della piramide e area della base, tanto più la misura è errata.

## Confronto tra intentatore integro e danneggiato

Si confrontano le misure ottenute con doppia diagonale e quelle con vertice estrapolato da un indentatore danneggiato per stabilire quale sia più affidabile: se il p-value del confronto con la doppia diagonale è maggiore di quello ottenuto dal confronto con quelle ottenute estrapolando la posizione, allora conviene usare due volte la stessa diagonale.

```{r}
t.test(df_a$HV30_OK,df_a$HV30_dd,paired = T)%>%tidy()%>%kable()
```



* Quindi, se si ha a disposizione solo l'indentatore danneggiato, è preferibile utilizzare due volte la stessa diagonale. Ovviamente, questa conclusione è valida solo per l'indentatore e per il campo di applicazione specifico considerato.

* Si sottolinea che (non si è riportata l'analisi) è necessario verificare le ipotesi che stanno alla base del T test accoppiato


## Analisi per taratura

E' necessario creare una tabella di raccolta dati. Si sceglie di indagare per 6 materiali differenti (rappresentanti 6 diverse durezze) la relazione tra stima e durezza effettiva per 5 scale differenti (HV5,HV10,HV20;HV30;HV50).

```{r}
#| include: false
df_b<-expand.grid(
  Scale=c("HV5","HV10","HV20","HV30","HV50"),
  Material=1:6
)%>%
  relocate(Material,.before = Scale)%>%
  mutate(
    StdOrder = 1:n(),
    RunOrder = sample(n()),
    .before=Material
  )%>%
  mutate(
    Estimated=NA,
    Hardness=NA
  )%>%
  arrange(RunOrder)%>%
  tibble()

if (!file.exists("misure_per_taratura.csv")){
  write.csv(df_b,"misure_per_taratura.csv")  #serve per avere la tabella in formato .csv così da poter essere riempita dallo speriementatore
}

kable(df_b, caption = "Tabella di raccolta dati per taratura")

```

```{r}
df_b<-df_b%>%
  arrange(StdOrder) %>%
  mutate(Load = str_extract(Scale, "HV(\\d+)", group=1) %>% as.numeric(), .after=Scale) %>%
  mutate(
    Estimated=c(692,690,516,634,630,343,310,262,318,370,223,217,185,218,209,
                610,641,481,589,680,304,290,238,297,340,235,229,173,212,205),
    Hardness=c(709,709,668,680,656,351,341,333,330,341,294,254,261,251,241,
                671,675,642,646,627,308,317,296,294,295,308,286,265,261,249)
    
  ) %>%
  mutate(Material=factor(Material))

kable(head(df_b),caption = "Dati per analisi di taratura")
```

## Analisi per taratura

Si visualizzano le regressioni dei modelli lineari effettuati separatamente per ogni scala (Si correla duque solamente la stima alla durezza). 

```{r}
#| warning: false
df_b %>%
  ggplot(aes(x=Hardness, y=Estimated, group=Scale, color=Scale)) + 
  geom_point(aes(shape=Material)) + 
  geom_smooth(method="lm", formula=y~x-1)+
  labs(
    y="Stima",
    x="Durezza",
    color="Scala",
    shape="Materiale"
  )
```

Non tutte le bande di confidenza risultano sovrapposte, questo significa che la relazione tra durezza reale e stima dipende dalla scala scelta.

## Analisi per taratura

Si effettua una ANOVA per verificare se la scala effettivamente sia un fattore che incide sul modello da regredire.

```{r}
df_b.lm <- lm(Estimated~Hardness + Scale, data = df_b)

anova(df_b.lm)%>%tidy()%>%kable(caption="Tabella ANOVA")
```

## Analisi per taratura


Al solito si verificano i residui del modello usato per l'analisi ANOVA. (assenza di pattern e normalità).

```{r}
p1<-df_b %>% 
  add_residuals(df_b.lm) %>%
  ggplot(aes(x=Scale, y=resid)) + 
  geom_point()+
  labs(
    title="Residui vs Scala",
    x="Scala",
    y="Residui"
  )

p2<-df_b %>% 
  add_residuals(df_b.lm) %>%
  ggplot(aes(x=Hardness, y=resid)) + 
  geom_point()+
  labs(
    title="Residui vs Durezza",
    x="Durezza",
    y="Residui"
  )


p3<-df_b %>% 
  add_residuals(df_b.lm) %>%
  ggplot(aes(x=RunOrder, y=resid)) + 
  geom_point()+
  labs(
    title="Residui vs RunOrder",
    x="RunOrder",
    y="Residui"
  )

p4<-df_b %>% 
  add_residuals(df_b.lm) %>%
  add_predictions(df_b.lm)%>%
  ggplot(aes(x=pred, y=resid)) + 
  geom_point()+
  labs(
    title="Residui vs Predizioni",
    x="Predizioni",
    y="Residui"
  )

(p1+p2)/(p3+p4)
```
## Analisi per taratura


```{r}
df_b %>% 
  add_residuals(df_b.lm) %>%
  ggplot(aes(sample=resid)) + 
  geom_qq() + 
  geom_qq_line()+
  labs(
    title="Grafico quantile-quantile"
  )

df_b %>%
  add_residuals(df_b.lm) %>%
  pull(resid) %>%
  shapiro.test()
```
## Analisi per taratura


La anova appena condotta risulta quindi valida e suggerisce di effettuare una regressione distinta per ogni scala ricavando per ognuna il valore della pendenza:

```{r}
df_slope<-df_b %>%
  group_by(Scale) %>%
  summarise(slope = lm(Estimated~Hardness - 1) %>% coefficients())

df_slope%>%kable(caption="Pendenza della caratteristica lineare di ogni scala")
```
## Analisi per taratura


Per ogni scala di durezza si riportano i valori della pendenza, i valori dell'intervallo di confidenza al 95% sul valore della pendenza e il range massimo dei residui (che risulta abbastanza importante).

```{r}
df_b %>%
  split(~Scale) %>%
  map_dfr(~{
    d.lm <- lm(Estimated ~ Hardness - 1, data = .x)
    tibble(
      Scale = unique(.x$Scale),
      Slope = coef(d.lm),
      Residual_min = min(residuals(d.lm)),
      Residual_max = max(residuals(d.lm)),
      CI_low = confint(d.lm)[1, 1],
      CI_high = confint(d.lm)[1, 2]
    )
  })%>%
  kable()
```
## Analisi per taratura

Va verificata come al solito l'assenza di pattern per i residui e la normalità degli stessi per il modello adottato.

```{r}
#| warning: false

# Modelli per ciascuna scala
df_models <- df_b %>%
  group_split(Scale) %>%
  set_names(map_chr(., ~ unique(.x$Scale))) %>%
  map(~ {
    mod <- lm(Estimated ~ Hardness - 1, data = .x)
    .x %>%
      add_residuals(mod) %>%
      add_predictions(mod)%>%
      mutate(model = list(mod))
  })

# Unione in unico dataframe
df_resid <- bind_rows(df_models)

p5<-ggplot(df_resid, aes(x = Hardness, y = resid)) +
  geom_point() +
  labs(
    title = "Residui vs Durezza",
    x="Durezza",
    y="Residui"
    )+
  facet_wrap(~Scale)

p6<-ggplot(df_resid, aes(x = pred, y = resid)) +
  geom_point() +
  labs(
    title = "Residui vs Predizioni",
    x="Predizioni",
    y="Residui"
       )+
  facet_wrap(~Scale)

p7<-ggplot(df_resid, aes(x = RunOrder, y = resid)) +
  geom_point() +
  labs(
    title = "Residui vs RunOrder",
    x="RunOrder",
    y="Residui"
    )+
  facet_wrap(~Scale)
```

```{r}
p5
```

## Analisi per taratura
```{r}
p6
```
## Analisi per taratura
```{r}
p7
```

## Analisi per taratura

```{r}

df_shapiro <- df_resid %>%
  group_by(Scale) %>%
  summarise(
    p_value = shapiro.test(resid)$p.value,
    W = shapiro.test(resid)$statistic
  )

df_shapiro%>%kable(caption="Valori del p_value e della statistica del test di shapiro (W) per ogni scala")

```
  
## Analisi per taratura

```{r}

ggplot(df_resid, aes(sample = resid)) +
  geom_qq() +
  geom_qq_line() +
  facet_wrap(~ Scale) +
  labs(title = "QQ-plot dei residui per ogni scala")
```
## Analisi per taratura

:::{.callout-note title="Conclusione"}
Il modello risulta valido. Quindi per le varie scale si possono assumere i valori della pendenza (slope) contenuti in`df_slope`.
:::

```{r}
df_slope%>%kable(caption="Pendenza della caratteristica lineare di ogni scala")
```

## Analisi per taratura

Si graficano le varie caratteristiche con il loro intervallo di confidenza

```{r}

pred_data <- df_b %>%
  split(~Scale) %>%
  map_dfr(~{
    d.lm <- lm(Estimated ~ Hardness - 1, data = .x)
    
    # griglia di valori per Hardness
    newdat <- tibble(Hardness = seq(min(.x$Hardness), max(.x$Hardness), length.out = 100))
    
    # predizioni con intervallo di confidenza
    preds <- as.data.frame(predict(d.lm, newdata = newdat, interval = "confidence"))
    
    bind_cols(
      tibble(Scale = unique(.x$Scale)),
      newdat,
      preds
    )
  })

ggplot(pred_data, aes(x = Hardness, y = fit)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.3) +
  geom_line(color = "blue", size = 1) +
  facet_wrap(~Scale) +
  labs(
    title = "Caratteristica stima-durezza di ogni scala",
    x = "Durezza",
    y = "Stima"
  ) 

```